<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  stroke: #fff;
  stroke-width: 1.5px;
}

.channels path {
  fill: none;
  stroke: #bbb;
}

</style>
<svg width="960" height="600"></svg>
<script src="../node_modules/d3/dist/d3.js"></script>
<script>

var colors = d3.scaleOrdinal(d3.schemeCategory10);

const NODE_RADIUS = 20;
const NODE_STROKE_WIDTH = 0;
const NODE_FILL_COLOR = colors(0);
const NODE_LABEL_COLOR = '#FFF';

const PATH_STROKE_WIDTH = 3;
const PATH_STROKE_COLOR = '#999';

const BEAD_RADIUS = 10;
const BEAD_SPACING = 0;
const BEAD_STROKE_WIDTH = 0;
const BEAD_FILL_COLOR = colors(1);

const ANIMATIN_DURATION = 1000;
const ANIMATIN_DELAY = ANIMATIN_DURATION*0.1;

const SPACING = 2*BEAD_RADIUS+BEAD_SPACING;
const FIRST_POSITION = NODE_RADIUS+BEAD_RADIUS+BEAD_SPACING; 

var svg = d3.select("svg"),
    width = +svg.attr("width"),
    height = +svg.attr("height");

var simulation = d3.forceSimulation()
	.alphaDecay(0.2)
	.force("link", d3.forceLink().id(function(d) { return d.id; }))
	.force("charge", d3.forceManyBody().strength(-20000))
	.force("center", d3.forceCenter(width / 2, height / 2));

var nodes = [{
	id: "Alice",
	color: colors(3),
	balance: 2
}, {
	id: "Hub1",
	color: colors(4),
	balance: 10
}, { 
	id: "Hub2",
	color: colors(5),
	balance: 20
}, { 
	id: "Bob",
	color: colors(6),
	balance: 4
}];

var links = [{
	source: "Alice", 
	target: "Hub1",
	sourceBalance: 1,
	targetBalance: 0
}, {
	source: "Hub1", 
	target: "Hub2",
	sourceBalance: 2,
	targetBalance: 0
}, {
	source: "Hub1", 
	target: "Bob",
	sourceBalance: 3,
	targetBalance: 0
}, {
	source: "Bob", 
	target: "Hub2",
	sourceBalance: 4,
	targetBalance: 0
}];

var nodes = nodes;
var nodeById = d3.map(nodes, function(d) { return d.id; });
var connections = [];
var beads = [];

links.forEach(function(link) {
	connections.push({
		source: nodeById.get(link.source), 
		target: nodeById.get(link.target),
		sourceBalance: link.sourceBalance,
		targetBalance: link.targetBalance
	});
});

var linkContainer = svg.append("g").attr("class", "channels");

var channels = linkContainer.selectAll(".channel")
	.data(connections)
	.enter().append("g")
		.attr("class", "channel")
		.attr("source-balance", (d) => {
			return d.sourceBalance;
		})
		.attr("target-balance", (d) => {
			return d.targetBalance;
		});

var paths = channels.append("path");

channels.each(function(d, n) {
	for (let i=0; i<(d.sourceBalance); i++) {
		var bead = d3.select(this).append("circle")
			.style("stroke-width", BEAD_STROKE_WIDTH)
			.style("fill", BEAD_FILL_COLOR)
			.attr("index", i)
			.attr("r", BEAD_RADIUS);
		beads.push(bead);
	}
});



var nodeContainer = svg.append("g").attr("class", "nodes");

var node = nodeContainer.selectAll(".node")
	.data(nodes)
	.enter().append("g")
		.attr("id", (d) => d.id)
		.attr("balance", (d) => d.balance)

var circle = node.append("circle")
	.attr("class", "node")
	.attr("r", NODE_RADIUS)
	.attr("fill", function(d) { return d.color; })
	.call(d3.drag()
		.on("start", dragstarted)
		.on("drag", dragged)
		.on("end", dragended));

var labels = node.append("text")
	.attr("stroke", NODE_LABEL_COLOR)
	.attr("fill", NODE_LABEL_COLOR)
	.attr("font-family", "sans-serif")
	.attr("font-size", "12px")
	.attr("text-anchor", "middle")
	.attr("pointer-events", "none")
	.text((d) => d.balance);

node.append("title")
	.text(function(d) { return d.id; });



simulation
	.nodes(nodes)
	.on("tick", ticked);

simulation.force("link")
	.links(links);

function ticked() {
	paths.attr("d", positionLink);
	node.attr("transform", positionNode);
	beads.forEach((bead) => bead.attr("transform", positionBeat));
}

function positionLink(d) {
	return "M" + d.source.x + "," + d.source.y + " " + d.target.x + "," + d.target.y;
}

function positionNode(d) {
	return "translate(" + d.x + "," + d.y + ")";
}

function positionBeat(d) {
	console.log(this, d);
	let index = d3.select(this).attr("index");
	var path = d3.select(this.parentNode).select('path');
	var beadPosition = path.node().getPointAtLength(FIRST_POSITION + index*SPACING);
	return "translate(" + [beadPosition.x, beadPosition.y] + ")";
}

function dragstarted(d) {
	if (!d3.event.active) simulation.alphaTarget(0.3).restart();
	d.fx = d.x, d.fy = d.y;
}

function dragged(d) {
	d.fx = d3.event.x, d.fy = d3.event.y;
}

function dragended(d) {
	if (!d3.event.active) simulation.alphaTarget(0);
	d.fx = null, d.fy = null;
}

</script>